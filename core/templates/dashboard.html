{% extends "layout/base.html" %}
{% load static %}

{% block content %}
<div class="d-flex">
    {% include "layout/sidebar.html" %}
    <div class="w-100">
<br>        
        <!-- Search form -->
        <form method="get" class="form-inline mb-4">
            <div class="form-group mb-2">
                <select name="search" class="form-control" style="width: 150px;">
                    <option value="">Select Brand</option>
                    {% for brand in brands %}
                        <option value="{{ brand }}" {% if brand == search_query %}selected{% endif %}>{{ brand }}</option>
                    {% endfor %}
                </select>
            </div>
            <button type="submit" class="btn btn-primary mb-2 ml-2">Search</button>
        </form>

        <div class="row">
            <div class="col-md-8">
                <table class="table table-striped table-bordered">
                    <thead class="thead-dark">
                        <tr>
                            {% if header %}
                                {% for header_item in header %}
                                    <th>{{ header_item }}</th>
                                {% endfor %}
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in paginated_data %}
                            <tr>
                                {% for column in row %}
                                    <td>{{ column }}</td>
                                {% endfor %}
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>

                <!-- Pagination controls -->
                <nav aria-label="Page navigation">
                    <ul class="pagination justify-content-center">
                        {% if paginated_data.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?search={{ search_query }}&page=1">&laquo; First</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?search={{ search_query }}&page={{ paginated_data.previous_page_number }}">Previous</a>
                            </li>
                        {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">&laquo; First</span>
                            </li>
                            <li class="page-item disabled">
                                <span class="page-link">Previous</span>
                            </li>
                        {% endif %}

                        <li class="page-item active">
                            <span class="page-link">
                                Page {{ paginated_data.number }} of {{ paginated_data.paginator.num_pages }}
                            </span>
                        </li>

                        {% if paginated_data.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?search={{ search_query }}&page={{ paginated_data.next_page_number }}">Next</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?search={{ search_query }}&page={{ paginated_data.paginator.num_pages }}">Last &raquo;</a>
                            </li>
                        {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">Next</span>
                            </li>
                            <li class="page-item disabled">
                                <span class="page-link">Last &raquo;</span>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
            </div>

            <!-- Pie chart -->
            <div class="col-md-4">
                <canvas id="sentimentChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    var ctx = document.getElementById('sentimentChart').getContext('2d');
    var sentimentChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: ['Positive', 'Negative','Neutral'],
            datasets: [{
                label: 'Sentiment Analysis',
                data: [{{ positive_count }}, {{ negative_count }}, {{ neutral_count }}],
                backgroundColor: ['#4caf50', '#f44336', '#3364FF'],
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'top',
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.raw !== null) {
                                label += new Intl.NumberFormat('en-US', {
                                    style: 'percent',
                                    minimumFractionDigits: 2
                                }).format(context.raw / ({{ positive_count }} + {{ negative_count }} + {{ neutral_count }}));
                            }
                            return label;
                        }
                    }
                }
            }
        }
    });
</script>
{% endblock content %}
